# ESP32の使用で得た知見
ESP32は(たぶん)COREで初めて使うマイコンボードです．使い方が分からないことも多いと思うので，使用していく中で得られた知見をここにまとめていきましょう．<br>

・[準備](https://github.com/CORE-since2020/Duo/blob/main/ESP32%E3%81%A7%E5%BE%97%E3%81%9F%E7%9F%A5%E8%A6%8B.md#%E6%BA%96%E5%82%99)<br>
・[プログラムの書き込み](https://github.com/CORE-since2020/Duo/blob/main/ESP32%E3%81%A7%E5%BE%97%E3%81%9F%E7%9F%A5%E8%A6%8B.md#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF)<br>
・[シリアル通信](https://github.com/CORE-since2020/Duo/blob/main/ESP32%E3%81%A7%E5%BE%97%E3%81%9F%E7%9F%A5%E8%A6%8B.md#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E9%80%9A%E4%BF%A1)<br>
・[I2C通信](https://github.com/CORE-since2020/Duo/blob/main/ESP32%E3%81%A7%E5%BE%97%E3%81%9F%E7%9F%A5%E8%A6%8B.md#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E9%80%9A%E4%BF%A1)<br>
・[アナログ入力](https://github.com/CORE-since2020/Duo/blob/main/ESP32%E3%81%A7%E5%BE%97%E3%81%9F%E7%9F%A5%E8%A6%8B.md#%E3%82%A2%E3%83%8A%E3%83%AD%E3%82%B0%E5%85%A5%E5%8A%9B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)<br>

## ESP32のピン配置
![ESP32ピン配置](https://github.com/CORE-since2020/Duo/blob/main/image/esp32_devkitc_pinout_01.png?raw=true)
## 準備
1. PCと接続
	- ESP32の接続ポートはUSBのmicro typeB
2. (Windows)デバイスマネージャーを開いてESP32が認識されているか確認する
	
	- もしドライバーがインストールされていなかったら自動更新でインストールする
3. Arduino IDEにESP32のボード情報をインストールする
	1. Arduino IDEを開く
	
	2. "ファイル"→"環境設定"を開く
	
	3. 追加のボードマネージャのURLの部分に次のURLをコピーして貼り付ける<br>					https://dl.espressif.com/dl/package_esp32_index.json
	4. OKボタンを押す
	5. "ツール"→"ボード"→"ボードマネージャ"を開く
	6. 検索欄に"esp32"と入力して検索
	7. インストールを押す
	8. インストールが完了したら"ツール"→"ボード"を開いて一覧に"ESP32 Dev Module"があることを確認して選択する
4. COMポートを設定する(PC-ESP32のシリアル通信の設定)
	1．(Windows)デバイスマネージャーに出てくる"Silicon Labs CP210x USB to UART Bridge"に表示されているCOM番号を控える
	2. "ツール"→"シリアルポート"を開き，先ほど控えたCOM番号を選択する
## プログラム書き込み
1. まずArduino IDEの左上のレ点を押してコンパイルできるか確かめる(デバック)
2. この時ファイルを保存していないと自動的に保存するように促されるので，任意のディレクトリに保存
3. デバック完了したらレ点の隣の矢印を押す
4. ウィンドウ下に"書き込み完了しました"と表示されればOK
5. 通常のArduinoならここから自動でプログラムが開始するが，ESP32はどうやらそうじゃないらしい．ENと書いてるタクトスイッチ(リセットボタン)を押すとプログラムが開始する．書き込んでも動かないからといって故障と勘違いしないように．
## シリアル通信
- 初期のシリアル通信でESP32側からなんか文字列送ってくる
	- 多分ボードの情報が表示される
	- ESP32の起動時のボーレートがデフォルトで115200bpsのようで，これ以外のボーレートで通信開始すると文字化けする
	- もちろんsetup()でSerial.begin(baudrate)でボーレート設定すれば，最初を除いて任意のボーレートで通信できる
	- とりあえずこの初期の読み出しはそこまで重要じゃないのでたとえ文字化けしてても無視(任意のボーレートで良さそう)
- UARTのポートはデフォルト2組使える

	|変数名|RXピン|TXピン|
	|:---:|:---:|:---:|
	|Serial|3|1|
	|Serial2|16|17|

- Serial1も存在するがデフォルトでは使用できない．今回はGPSモジュールと無線機の2組のみでUARTを使用するため割愛する．
- プログラミングを書き込む際，PCとESP32のシリアル通信はSerialを使う．なので書き込む時にGPIO3とGPIO1にそれぞれ接続した状態のままだと書き込みに失敗する．
- PCとESP32をシリアル通信しながらGPSまたは無線機をESP32と接続してシリアル通信する際は，以下のように接続する．逆だと通信できなかった．

	|通信区間|変数名|
	|:---:|:---:|
	|PC - ESP32|Serial|
	|GPS or Wireless - ESP32|Serial2|

## I2C通信
- ESP32でのI2Cのピンのアサインは以下のようになっている

|ピン名|ピン番号|
|:---:|:---:|
|SDA|21|
|SCL|22|
- プルアップ抵抗を挟むか挟まないかはセンサモジュールの仕様による
	- 今回使うMPU6050やME280のモジュールにはプルアップ抵抗があるので外部でプルアップする必要もないし，ESP32側からも何もしなくてもいい
	- もしプルアップをESP32側から設定するならpinMode()の第二引数に"INPUT_PULLUP"を入れる
### Wire.hの扱いについて
- ArduinoだとWire.begin()の引数には何も入れなかったが，ESP32では第一引数にSDAピン番号，第二引数にSCLピン番号を入れる

## アナログ入力
- A1，A2，A8，A9を除いたA0-A19の計1個のピンがアナログ入力として使用可能
- A〇っていう番号はアナログ入力ピン番号であり，I/Oピン番号とは異なることに注意
	- マイコンボード左側のピン(USBポートを手前にしたとき)
	
	|アナログ入力ピン番号|I/Oピン番号|
	|:---:|:---:|
	|A0|36|
	|A3|39|
	|A6|34|
	|A7|35|
	|A4|32|
	|A5|33|
	|A18|25|
	|A19|26|
	|A17|27|
	|A16|14|
	|A15|12|
	|A14|13|
	
	- マイコンボード右側のピン(USBポートを手前にしたとき)
	
	|アナログ入力ピン番号|I/Oピン番号|
	|:---:|:---:|
	|A10|4|
	|A11|0|
	|A12|2|
	|A13|15|
	
	- ピン番号は順番に並んでいるわけではないことに注意
	- AnalogRead()の引数にはアナログ入力番号，I/Oピン番号のどちらを入れてもいい
- ESP32においてAnalogRead()のレンジは0-4095であることに注意(Arduinoでは0-1023)
	- 精度はESP32のほうがいい
- I/Oピンの基準電圧は3.3V
	- 5V出力のアナログ出力のセンサを用いる場合はセンサとマイコンボードの間にレベル変換ICを挟む必要がある
- A11(I/O0)のピンを使うとき，ピンに接続したままプログラムを書き込もうとするとエラーがでる
	- たぶんSerialの時と同じ現象
